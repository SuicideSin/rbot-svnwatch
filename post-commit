#!/usr/bin/env ruby

require 'drb'

# Okay.  So we get two args from svn.
#
# [1] - repo path
# [2] - revision number
#
# We then use this information to gather relevant data about the commit
# and do with it as we please.

path = ARGV[0]
rev = ARGV[1]

if (path.nil? || rev.nil?)
  puts "Usage: post-commit <repo path> <rev number>"
  exit
end

DRb.start_service

sw = DRbObject.new(nil, 'druby://127.0.0.1:7666')

info_array = `svnlook info --revision #{rev} #{path}`.split(/\n/, 4)

changed = `svnlook changed -r #{rev} #{path}`.strip

# colorize it. we can make this look pretty later
message = "\0032#{info_array[0]}\003 * \0039rev\003 \002[#{rev}]\002 \0037#{changed}\003 #{info_array[3]}"

sw.send_msg message

# example(s)
#puts "Committer: #{info_array[0]}"
#puts "When: #{info_array[1]}"
#puts "Log: #{info_array[3]}"

